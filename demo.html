<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apple Financial Dashboard - SEC Data Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/recharts@2.8.0/umd/Recharts.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="dashboard-container" class="p-6 min-h-screen">
        <!-- Loading State -->
        <div id="loading" class="flex items-center justify-center min-h-screen">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                <p class="text-gray-600">Loading Apple Financial Data...</p>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboard" class="hidden">
            <!-- Header -->
            <div class="mb-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900 mb-2">Apple Inc. Financial Dashboard - Real Data</h1>
                        <p class="text-gray-600">SEC Filing Data Analysis - Real-time EDGAR API Data</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <!-- Period Selector -->
                        <div class="flex items-center gap-2">
                            <label class="text-sm font-medium text-gray-700">Period:</label>
                            <select id="period-selector" class="px-3 py-1 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 bg-white">
                                <option value="latest">Latest (Q2 2025)</option>
                                <option value="annual">Annual View</option>
                            </select>
                        </div>
                        
                        <!-- View Selector -->
                        <div class="flex gap-2">
                            <button id="overview-btn" class="px-4 py-2 rounded-lg font-medium bg-blue-600 text-white">
                                Overview
                            </button>
                            <button id="detailed-btn" class="px-4 py-2 rounded-lg font-medium bg-white text-gray-600 border border-gray-300">
                                Detailed
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary Cards -->
            <div id="summary-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Cards will be populated by JavaScript -->
            </div>

            <!-- Charts Section -->
            <div id="charts-section" class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <!-- Financial Trends Chart -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Financial Performance Trends</h3>
                    <div id="trends-chart" class="h-80">
                        <!-- Chart will be rendered here -->
                    </div>
                </div>

                <!-- Growth Analysis Chart -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Growth Rate Analysis</h3>
                    <div id="growth-chart" class="h-80">
                        <!-- Chart will be rendered here -->
                    </div>
                </div>
            </div>

            <!-- Key Financial Ratios -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-8">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Key Financial Insights</h3>
                <div id="financial-ratios" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Ratios will be populated by JavaScript -->
                </div>
            </div>

            <!-- Data Source Information -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Data Source & Quality</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="flex items-center p-4 bg-green-50 rounded-lg">
                        <i data-lucide="check-circle" class="h-6 w-6 text-green-600 mr-3"></i>
                        <div>
                            <p class="font-medium text-green-900">SEC EDGAR Database</p>
                            <p class="text-sm text-green-700" id="data-source-note">Official 10-K & 10-Q Filings</p>
                        </div>
                    </div>
                    <div class="flex items-center p-4 bg-blue-50 rounded-lg">
                        <i data-lucide="calendar" class="h-6 w-6 text-blue-600 mr-3"></i>
                        <div>
                            <p class="font-medium text-blue-900">Data Freshness</p>
                            <p class="text-sm text-blue-700" id="last-updated">Updated: Loading...</p>
                        </div>
                    </div>
                    <div class="flex items-center p-4 bg-purple-50 rounded-lg">
                        <i data-lucide="lightbulb" class="h-6 w-6 text-purple-600 mr-3"></i>
                        <div>
                            <p class="font-medium text-purple-900">GAAP Compliant</p>
                            <p class="text-sm text-purple-700">US-GAAP Standard Metrics</p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                    <p class="text-sm text-gray-600">
                        <strong>Note:</strong> All financial data is sourced directly from Apple Inc.'s SEC filings using the EDGAR API. 
                        Values are presented in billions of USD. Growth rates are calculated year-over-year based on the most recent 
                        comparable periods available in the filings.
                    </p>
                </div>
            </div>

            <!-- Footer -->
            <div class="mt-8 pt-6 border-t border-gray-200">
                <p class="text-sm text-gray-500">
                    Apple Financial Dashboard | Data Source: SEC EDGAR API | 
                    Company CIK: 0000320193 | Generated: <span id="generated-date"></span>
                </p>
            </div>
        </div>
    </div>

    <!-- Chat Button and Modal -->
    <button id="chat-btn" class="fixed bottom-6 right-6 bg-blue-600 text-white rounded-full p-4 shadow-lg z-50">
      ðŸ’¬
    </button>
    <div id="chat-modal" class="fixed bottom-20 right-6 w-80 bg-white rounded-xl shadow-lg border border-gray-200 p-4 z-50 hidden">
      <div id="chat-messages" class="h-48 overflow-y-auto mb-2 text-sm"></div>
      <form id="chat-form" class="flex gap-2">
        <input id="chat-input" type="text" class="flex-1 border rounded-lg px-2 py-1" placeholder="Ask about the dashboard..." autocomplete="off" />
        <button type="submit" class="bg-blue-600 text-white px-3 py-1 rounded-lg">Send</button>
      </form>
    </div>
    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Load and display SEC data
        async function loadDashboard() {
            try {
                // Load SEC data
                const response = await fetch('./apple_sec_dashboard_data.json');
                const secData = await response.json();
                
                // Hide loading, show dashboard
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                
                // Store data globally for detailed view
                globalSecData = secData;
                
                // Populate dashboard with data
                populateSummaryCards(secData);
                populateFinancialRatios(secData);
                updateTimestamps(secData);
                
                // Update overview content if we're in overview mode
                if (currentView === 'overview') {
                    showOverviewContent();
                }
                
                console.log('Dashboard loaded successfully with SEC data');
                
            } catch (error) {
                console.error('Error loading SEC data:', error);
                
                // Show error state or fallback data
                document.getElementById('loading').innerHTML = `
                    <div class="text-center">
                        <i data-lucide="alert-circle" class="h-12 w-12 text-red-600 mx-auto mb-4"></i>
                        <p class="text-gray-600">Error loading financial data</p>
                        <p class="text-sm text-gray-500 mt-2">Please ensure apple_sec_dashboard_data.json is available</p>
                    </div>
                `;
                lucide.createIcons();
            }
        }

        function formatValue(value) {
            const numValue = typeof value === 'string' ? parseFloat(value) : value;
            return (numValue / 1000000000).toFixed(1); // Convert to billions
        }

        function populateSummaryCards(secData) {
            const currentMetrics = getMetricsForPeriod(secData, currentPeriod);
            
            const summaryCards = [
                {
                    key: 'revenue',
                    title: 'Total Revenue',
                    value: formatValue(currentMetrics.revenue?.latest_value || currentMetrics.revenue?.latest_quarterly_value || 0),
                    growth: currentPeriod === 'quarterly' ? 
                        (currentMetrics.revenue?.quarterly_vs_annual_change || 0) : 
                        (currentMetrics.revenue?.growth_rate || 0),
                    icon: 'dollar-sign',
                    color: 'text-green-600',
                    bgColor: 'bg-green-50',
                    period: currentMetrics.revenue?.latest_period || currentMetrics.revenue?.latest_quarterly_period,
                    form: currentMetrics.revenue?.latest_form || '10-Q'
                },
                {
                    key: 'net_income',
                    title: 'Net Income',
                    value: formatValue(currentMetrics.net_income?.latest_value || currentMetrics.net_income?.latest_quarterly_value || 0),
                    growth: currentPeriod === 'quarterly' ? 
                        (currentMetrics.net_income?.quarterly_vs_annual_change || 0) : 
                        (currentMetrics.net_income?.growth_rate || 0),
                    icon: 'target',
                    color: 'text-blue-600',
                    bgColor: 'bg-blue-50',
                    period: currentMetrics.net_income?.latest_period || currentMetrics.net_income?.latest_quarterly_period,
                    form: currentMetrics.net_income?.latest_form || '10-Q'
                },
                {
                    key: 'total_assets',
                    title: 'Total Assets',
                    value: formatValue(currentMetrics.total_assets?.latest_value || currentMetrics.total_assets?.latest_quarterly_value || 0),
                    growth: currentPeriod === 'quarterly' ? 
                        (currentMetrics.total_assets?.quarterly_vs_annual_change || 0) : 
                        (currentMetrics.total_assets?.growth_rate || 0),
                    icon: 'building',
                    color: 'text-purple-600',
                    bgColor: 'bg-purple-50',
                    period: currentMetrics.total_assets?.latest_period || currentMetrics.total_assets?.latest_quarterly_period,
                    form: currentMetrics.total_assets?.latest_form || '10-Q'
                },
                {
                    key: 'cash_and_equivalents',
                    title: 'Cash & Equivalents',
                    value: formatValue(currentMetrics.cash_and_equivalents?.latest_value || currentMetrics.cash_and_equivalents?.latest_quarterly_value || 0),
                    growth: currentPeriod === 'quarterly' ? 
                        (currentMetrics.cash_and_equivalents?.quarterly_vs_annual_change || 0) : 
                        (currentMetrics.cash_and_equivalents?.growth_rate || 0),
                    icon: 'piggy-bank',
                    color: 'text-yellow-600',
                    bgColor: 'bg-yellow-50',
                    period: currentMetrics.cash_and_equivalents?.latest_period || currentMetrics.cash_and_equivalents?.latest_quarterly_period,
                    form: currentMetrics.cash_and_equivalents?.latest_form || '10-Q'
                }
            ];

            const cardsContainer = document.getElementById('summary-cards');
            cardsContainer.innerHTML = summaryCards.map(card => `
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">${card.title}</p>
                            <p class="text-2xl font-bold text-gray-900">$${card.value}B</p>
                            ${card.period ? `<p class="text-xs text-gray-500 mt-1">${card.form} â€¢ ${new Date(card.period).toLocaleDateString()}</p>` : ''}
                        </div>
                        <div class="p-3 rounded-lg ${card.bgColor}">
                            <i data-lucide="${card.icon}" class="h-6 w-6 ${card.color}"></i>
                        </div>
                    </div>
                    <div class="flex items-center mt-3">
                        <i data-lucide="${card.growth >= 0 ? 'trending-up' : 'trending-down'}" 
                           class="h-4 w-4 ${card.growth >= 0 ? 'text-green-600' : 'text-red-600'}"></i>
                        <span class="ml-1 text-sm font-medium ${card.growth >= 0 ? 'text-green-600' : 'text-red-600'}">
                            ${card.growth >= 0 ? '+' : ''}${card.growth.toFixed(1)}%
                        </span>
                        <span class="ml-2 text-sm text-gray-500">${currentPeriod === 'quarterly' ? 'vs Annual' : 'YoY'}</span>
                    </div>
                </div>
            `).join('');

            // Reinitialize icons
            lucide.createIcons();
        }

        function populateFinancialRatios(secData) {
            const currentMetrics = getMetricsForPeriod(secData, currentPeriod);
            const revenue = parseFloat(currentMetrics.revenue?.latest_value || currentMetrics.revenue?.latest_quarterly_value || 0);
            const netIncome = parseFloat(currentMetrics.net_income?.latest_value || currentMetrics.net_income?.latest_quarterly_value || 0);
            const totalAssets = parseFloat(currentMetrics.total_assets?.latest_value || currentMetrics.total_assets?.latest_quarterly_value || 0);
            const cash = parseFloat(currentMetrics.cash_and_equivalents?.latest_value || currentMetrics.cash_and_equivalents?.latest_quarterly_value || 0);

            const profitMargin = revenue > 0 ? ((netIncome / revenue) * 100).toFixed(1) : '0.0';
            const roa = totalAssets > 0 ? ((netIncome / totalAssets) * 100).toFixed(1) : '0.0';
            const cashRatio = totalAssets > 0 ? ((cash / totalAssets) * 100).toFixed(1) : '0.0';

            const ratiosContainer = document.getElementById('financial-ratios');
            ratiosContainer.innerHTML = `
                <div class="text-center p-4 bg-blue-50 rounded-lg relative group">
                    <div class="text-2xl font-bold text-blue-600">${profitMargin}%</div>
                    <div class="text-sm text-gray-600 mt-1 flex items-center justify-center gap-1">
                        Net Profit Margin
                        <i data-lucide="info" class="h-4 w-4 text-blue-400 cursor-pointer" title="Net Profit Margin = Net Income / Revenue"></i>
                    </div>
                </div>
                <div class="text-center p-4 bg-green-50 rounded-lg relative group">
                    <div class="text-2xl font-bold text-green-600">${roa}%</div>
                    <div class="text-sm text-gray-600 mt-1 flex items-center justify-center gap-1">
                        Return on Assets
                        <i data-lucide="info" class="h-4 w-4 text-green-400 cursor-pointer" title="Return on Assets = Net Income / Total Assets"></i>
                    </div>
                </div>
                <div class="text-center p-4 bg-purple-50 rounded-lg relative group">
                    <div class="text-2xl font-bold text-purple-600">${cashRatio}%</div>
                    <div class="text-sm text-gray-600 mt-1 flex items-center justify-center gap-1">
                        Cash Ratio
                        <i data-lucide="info" class="h-4 w-4 text-purple-400 cursor-pointer" title="Cash Ratio = Cash & Equivalents / Total Assets"></i>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function updateTimestamps(secData) {
            const lastUpdated = new Date(secData.last_updated).toLocaleDateString();
            const generatedDate = new Date().toLocaleDateString();
            
            document.getElementById('last-updated').textContent = `Updated: ${lastUpdated}`;
            document.getElementById('generated-date').textContent = generatedDate;
        }

        // View mode state
        let currentView = 'overview';
        let currentPeriod = 'latest';
        let globalSecData = null;

        // Button event handlers
        function setupEventHandlers() {
            document.getElementById('overview-btn').addEventListener('click', function() {
                switchView('overview');
            });
            
            document.getElementById('detailed-btn').addEventListener('click', function() {
                switchView('detailed');
            });
            
            document.getElementById('period-selector').addEventListener('change', function(e) {
                switchPeriod(e.target.value);
            });
        }

        function switchView(view) {
            currentView = view;
            
            // Update button styles
            const overviewBtn = document.getElementById('overview-btn');
            const detailedBtn = document.getElementById('detailed-btn');
            
            if (view === 'overview') {
                overviewBtn.className = 'px-4 py-2 rounded-lg font-medium bg-blue-600 text-white';
                detailedBtn.className = 'px-4 py-2 rounded-lg font-medium bg-white text-gray-600 border border-gray-300';
                showOverviewContent();
            } else {
                overviewBtn.className = 'px-4 py-2 rounded-lg font-medium bg-white text-gray-600 border border-gray-300';
                detailedBtn.className = 'px-4 py-2 rounded-lg font-medium bg-blue-600 text-white';
                showDetailedContent();
            }
        }

        function switchPeriod(period) {
            currentPeriod = period;
            
            if (!globalSecData) return;
            
            // Update summary cards with selected period data
            populateSummaryCards(globalSecData);
            populateFinancialRatios(globalSecData);
            
            // Update content based on current view
            if (currentView === 'overview') {
                showOverviewContent();
            } else {
                showDetailedContent();
            }
            
            // Update the data source information
            updateDataSourceInfo(period);
        }

        function getMetricsForPeriod(secData, period) {
            switch(period) {
                case 'annual':
                    // Return only annual data
                    const annualMetrics = {};
                    for (const [key, data] of Object.entries(secData.summary_metrics)) {
                        if (data.latest_form === '10-K') {
                            annualMetrics[key] = data;
                        } else {
                            // If no annual data, try to find it from raw metrics
                            const rawMetric = secData.raw_metrics[key];
                            if (rawMetric && rawMetric.annual_data && rawMetric.annual_data.length > 0) {
                                const latestAnnual = rawMetric.annual_data[rawMetric.annual_data.length - 1];
                                annualMetrics[key] = {
                                    ...data,
                                    latest_value: latestAnnual.val,
                                    latest_year: latestAnnual.fy,
                                    latest_period: latestAnnual.end,
                                    latest_form: latestAnnual.form
                                };
                            }
                        }
                    }
                    return annualMetrics;
                case 'latest':
                default:
                    return secData.summary_metrics;
            }
        }

        function updateDataSourceInfo(period) {
            const dataSourceText = {
                'latest': 'Latest Available Data (Quarterly & Annual)',
                'annual': 'Annual Reports (10-K)'
            };
            
            const noteElement = document.querySelector('#data-source-note');
            if (noteElement) {
                noteElement.textContent = dataSourceText[period] || dataSourceText['latest'];
            }
        }

        function showOverviewContent() {
            if (!globalSecData) {
                document.getElementById('charts-section').innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 col-span-2">
                        <div class="text-center text-gray-500">
                            <i data-lucide="loader" class="h-16 w-16 mx-auto mb-4 text-blue-500 animate-spin"></i>
                            <p class="font-medium">Loading financial data...</p>
                        </div>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            // Get current metrics from global data
            const metrics = globalSecData.summary_metrics;
            const growthAnalysis = globalSecData.growth_analysis || [];

            document.getElementById('charts-section').innerHTML = `
                <!-- Financial Performance Overview -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Financial Performance Overview</h3>
                    <div class="h-80 flex flex-col justify-center">
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="text-center p-4 bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg">
                                <div class="text-2xl font-bold text-blue-600">$${formatValue(metrics.revenue?.latest_value || 0)}B</div>
                                <div class="text-sm text-blue-800">Total Revenue</div>
                                <div class="text-xs text-gray-600 mt-1">FY ${metrics.revenue?.latest_year || 'N/A'}</div>
                            </div>
                            <div class="text-center p-4 bg-gradient-to-br from-green-50 to-green-100 rounded-lg">
                                <div class="text-2xl font-bold text-green-600">$${formatValue(metrics.net_income?.latest_value || 0)}B</div>
                                <div class="text-sm text-green-800">Net Income</div>
                                <div class="text-xs text-gray-600 mt-1">FY ${metrics.net_income?.latest_year || 'N/A'}</div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3">
                            <div class="text-center p-3 bg-gray-50 rounded">
                                <div class="text-lg font-bold text-gray-700">$${formatValue(metrics.operating_income?.latest_value || 0)}B</div>
                                <div class="text-xs text-gray-600">Operating Income</div>
                            </div>
                            <div class="text-center p-3 bg-gray-50 rounded">
                                <div class="text-lg font-bold text-gray-700">$${formatValue(metrics.research_development?.latest_value || 0)}B</div>
                                <div class="text-xs text-gray-600">R&D Investment</div>
                            </div>
                            <div class="text-center p-3 bg-gray-50 rounded">
                                <div class="text-lg font-bold text-gray-700">$${formatValue(metrics.cash_and_equivalents?.latest_value || 0)}B</div>
                                <div class="text-xs text-gray-600">Cash Position</div>
                            </div>
                        </div>
                        
                        <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                            <div class="text-sm text-blue-800 text-center">
                                <strong>Market Position:</strong> Apple maintains strong financial fundamentals with 
                                $${formatValue(metrics.total_assets?.latest_value || 0)}B in total assets and consistent profitability.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Live Growth Rate Analysis -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Year-over-Year Growth Analysis</h3>
                    <div class="h-80 overflow-hidden">
                        <div class="space-y-2 h-full overflow-y-auto pr-2">
                            ${Object.entries(metrics).map(([key, metric]) => {
                                const growthRate = metric.growth_rate || 0;
                                const isPositive = growthRate >= 0;
                                return `
                                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                                        <div class="flex items-center min-w-0 flex-1">
                                            <i data-lucide="${isPositive ? 'trending-up' : 'trending-down'}" 
                                               class="h-4 w-4 ${isPositive ? 'text-green-600' : 'text-red-600'} mr-2 flex-shrink-0"></i>
                                            <span class="font-medium text-gray-800 truncate">${metric.name}</span>
                                        </div>
                                        <div class="flex items-center ml-4 flex-shrink-0">
                                            <div class="text-right">
                                                <div class="text-sm font-medium text-gray-900">$${formatValue(metric.latest_value)}B</div>
                                                <div class="text-sm font-bold ${isPositive ? 'text-green-600' : 'text-red-600'}">
                                                    ${isPositive ? '+' : ''}${growthRate.toFixed(1)}%
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <div class="mt-4 p-3 bg-gradient-to-r from-green-50 to-blue-50 rounded-lg">
                            <div class="text-sm text-gray-700 text-center">
                                <i data-lucide="info" class="h-4 w-4 inline mr-2 text-blue-600"></i>
                                Growth calculated from SEC 10-K filings
                            </div>
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function showDetailedContent() {
            document.getElementById('charts-section').innerHTML = `
                <!-- Metric Selector -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 col-span-2">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Detailed Financial Analysis</h3>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Metric for Analysis</label>
                        <select id="metric-selector" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="revenue">Total Revenue</option>
                            <option value="net_income">Net Income</option>
                            <option value="operating_income">Operating Income</option>
                            <option value="total_assets">Total Assets</option>
                            <option value="cash_and_equivalents">Cash & Equivalents</option>
                            <option value="research_development">Research & Development</option>
                        </select>
                    </div>
                    <div id="timeline-chart" class="h-64 bg-gray-50 rounded-lg p-4">
                        <div class="text-center text-gray-500 flex flex-col items-center justify-center h-full">
                            <i data-lucide="bar-chart-3" class="h-12 w-12 mx-auto mb-2 text-blue-500"></i>
                            <p class="font-medium">Historical Data Timeline</p>
                            <p class="text-sm">Select a metric to view historical trends</p>
                        </div>
                    </div>
                </div>

                <!-- Metric Details -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 col-span-2">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Metric Details</h3>
                    <div id="metric-details" class="space-y-4">
                        <div class="grid grid-cols-3 gap-4">
                            <div class="p-4 bg-blue-50 rounded-lg">
                                <p class="text-sm text-gray-600">Latest Value</p>
                                <p class="text-xl font-bold text-blue-600" id="latest-value">Select a metric</p>
                                <p class="text-xs text-gray-500" id="latest-year">--</p>
                            </div>
                            <div class="p-4 bg-green-50 rounded-lg">
                                <p class="text-sm text-gray-600">Growth Rate</p>
                                <p class="text-xl font-bold" id="growth-rate">--</p>
                                <p class="text-xs text-gray-500">Year over Year</p>
                            </div>
                            <div class="p-4 bg-purple-50 rounded-lg" id="quarterly-comparison" style="display: none;">
                                <p class="text-sm text-gray-600">Q vs Annual</p>
                                <p class="text-xl font-bold" id="quarterly-change">--</p>
                                <p class="text-xs text-gray-500">Latest Quarter vs Annual</p>
                            </div>
                        </div>
                        <div class="p-4 bg-gray-50 rounded-lg">
                            <p class="text-sm text-gray-600 mb-2">Historical Context</p>
                            <p class="text-sm" id="historical-context">Select a metric above to view detailed analysis and historical trends from SEC 10-K filings.</p>
                        </div>
                        <div id="historical-data" class="mt-4">
                            <!-- Historical data points will be shown here -->
                        </div>
                    </div>
                </div>
            `;
            
            // Add event listener for metric selector
            document.getElementById('metric-selector').addEventListener('change', function(e) {
                updateMetricDetails(e.target.value);
            });
            
            lucide.createIcons();
            
            // Load initial metric (revenue)
            updateMetricDetails('revenue');
        }

        function updateMetricDetails(metricKey) {
            if (!globalSecData) return;
            
            const metric = globalSecData.summary_metrics[metricKey];
            if (!metric) return;
            
            // Debug logs for troubleshooting
            const rawMetric = globalSecData.raw_metrics[metricKey];
            console.log('rawMetric:', rawMetric);
            console.log('rawMetric.data:', rawMetric && rawMetric.data);
            
            // Defensive: Ensure rawMetric.data is a valid array of objects with numeric val
            let validData = [];
            if (rawMetric && Array.isArray(rawMetric.data)) {
                validData = rawMetric.data.filter(d => d && !isNaN(parseFloat(d.val)) && d.end);
            }
            // Filter by period type (annual/quarterly) using the 'form' property
            let periodType = (typeof currentPeriod === 'string' && currentPeriod.toLowerCase().includes('annual')) ? '10-K' : (currentPeriod.toLowerCase().includes('quarter') ? '10-Q' : null);
            if (periodType) {
                validData = validData.filter(d => d.form === periodType);
            }
            console.log('Valid data points for chart (filtered by period):', validData);
            
            // Update metric details
            const latestValue = formatValue(metric.latest_value);
            const growthRate = metric.growth_rate;
            const latestYear = metric.latest_year;
            // Add info tooltips for growth rate and Q vs Annual
            document.getElementById('latest-value').textContent = `$${latestValue}B`;
            document.getElementById('latest-year').textContent = `${metric.latest_form} ${latestYear}`;
            const growthElement = document.getElementById('growth-rate');
            growthElement.innerHTML = `
                ${growthRate >= 0 ? '+' : ''}${growthRate.toFixed(1)}%
            `;
            // Show quarterly comparison if available
            const quarterlyMetric = globalSecData.quarterly_metrics[metricKey];
            const quarterlyComparison = document.getElementById('quarterly-comparison');
            if (quarterlyMetric && quarterlyMetric.quarterly_vs_annual_change !== undefined) {
                quarterlyComparison.style.display = 'block';
                const quarterlyChange = quarterlyMetric.quarterly_vs_annual_change;
                const quarterlyChangeElement = document.getElementById('quarterly-change');
                quarterlyChangeElement.innerHTML = `
                    ${quarterlyChange >= 0 ? '+' : ''}${quarterlyChange.toFixed(1)}%
                `;
            } else {
                quarterlyComparison.style.display = 'none';
            }
            
            // Update historical context
            const contextMessages = {
                'revenue': 'Apple\'s revenue shows significant quarterly variations due to seasonal product launches, particularly iPhone releases in Q1.',
                'net_income': 'Net income reflects Apple\'s strong profitability and efficient cost management across all product lines.',
                'operating_income': 'Operating income demonstrates Apple\'s core business performance before financing and tax considerations.',
                'total_assets': 'Total assets include cash reserves, investments, property, and intellectual property portfolios.',
                'cash_and_equivalents': 'Apple maintains substantial cash reserves for strategic investments and shareholder returns.',
                'research_development': 'R&D spending reflects Apple\'s commitment to innovation across hardware, software, and services.'
            };
            
            document.getElementById('historical-context').textContent = contextMessages[metricKey] || 'Historical data from SEC 10-K filings.';
            
            // Show historical data points if available
            const historicalHtml = `
                <h4 class="text-sm font-medium text-gray-700 mb-3">Recent Historical Data</h4>
                <div class="space-y-2 max-h-32 overflow-y-auto">
                    ${validData.length > 0 ? (() => {
                        // Sort by end date ascending
                        const sorted = validData
                            .map(d => ({...d, dateObj: new Date(d.end)}))
                            .sort((a, b) => a.dateObj - b.dateObj)
                            .slice(-5); // Last 5 sorted data points
                        return sorted.map((dataPoint, idx, arr) => {
                            const date = new Date(dataPoint.end);
                            const quarter = Math.ceil((date.getMonth() + 1) / 3);
                            const year = date.getFullYear();
                            const dateLabel = `Q${quarter} ${year}`;
                            const fullDate = date.toLocaleDateString();
                            const value = parseFloat(dataPoint.val);
                            // Calculate trend vs previous value
                            let trendHtml = '';
                            if (idx > 0) {
                                const prevValue = parseFloat(arr[idx-1].val);
                                if (!isNaN(prevValue) && prevValue !== 0) {
                                    const change = ((value - prevValue) / Math.abs(prevValue)) * 100;
                                    const isUp = change >= 0;
                                    trendHtml = `<span class=\"ml-2 text-sm font-medium ${isUp ? 'text-green-600' : 'text-red-600'}\">\n                                        <i data-lucide=\"${isUp ? 'trending-up' : 'trending-down'}\" class=\"inline h-4 w-4 ${isUp ? 'text-green-600' : 'text-red-600'}\"></i>\n                                        ${isUp ? '+' : ''}${change.toFixed(1)}%\n                                    </span>`;
                                }
                            }
                            // Show form type (10-Q or 10-K)
                            const formType = dataPoint.form ? `<span class=\"ml-2 px-2 py-0.5 rounded bg-gray-100 text-xs text-gray-700 border\">${dataPoint.form}</span>` : '';
                            return `
                                <div class=\"flex justify-between items-center p-2 bg-white rounded border\">
                                    <div class=\"flex flex-col\">
                                        <span class=\"text-sm text-gray-600 font-medium\">${dateLabel}</span>
                                        <span class=\"text-xs text-gray-500\">${fullDate}</span>
                                    </div>
                                    <span class=\"text-sm font-medium\">$${formatValue(dataPoint.val)}B${trendHtml}${formType}</span>
                                </div>
                            `;
                        }).join('');
                    })() : 'No historical data available'}
                </div>
            `;
            document.getElementById('historical-data').innerHTML = historicalHtml;
            
            // Always define timelineChart before using it
            const timelineChart = document.getElementById('timeline-chart');
            
            // For quarterly view, ensure 5 most recent consecutive quarters are shown, with placeholders for missing data
            if ((periodType === '10-Q' || currentPeriod === 'latest') && validData.length > 0) {
                // Map data by quarter string (e.g., 'Q1 2024')
                const dataByQuarter = {};
                validData.forEach(d => {
                    const date = new Date(d.end);
                    const quarter = Math.ceil((date.getMonth() + 1) / 3);
                    const year = date.getFullYear();
                    const key = `Q${quarter} ${year}`;
                    // Use the latest value for a given quarter if duplicates
                    if (!dataByQuarter[key] || new Date(d.end) > new Date(dataByQuarter[key].end)) {
                        dataByQuarter[key] = d;
                    }
                });
                // Find the most recent quarter
                const allQuarters = Object.keys(dataByQuarter).map(q => {
                    const [qtr, yr] = q.split(' ');
                    return {q, quarter: parseInt(qtr.replace('Q','')), year: parseInt(yr)};
                });
                allQuarters.sort((a, b) => (a.year - b.year) || (a.quarter - b.quarter));
                let mostRecent = allQuarters[allQuarters.length - 1];
                // Build the 5 most recent consecutive quarters
                const timeline = [];
                let q = mostRecent ? mostRecent.quarter : 4;
                let y = mostRecent ? mostRecent.year : (new Date()).getFullYear();
                for (let i = 0; i < 5; i++) {
                    timeline.unshift({quarter: q, year: y});
                    q--;
                    if (q === 0) { q = 4; y--; }
                }
                // Build uniqueData array for chart, with placeholders for missing
                const uniqueData = timeline.map(({quarter, year}) => {
                    // Find any data point (10-Q or 10-K) for this quarter/year
                    const found = validData.find(d => {
                        if (!d.end) return false;
                        const date = new Date(d.end);
                        const q = Math.ceil((date.getMonth() + 1) / 3);
                        const y = date.getFullYear();
                        return q === quarter && y === year;
                    });
                    if (found) {
                        return found;
                    } else {
                        return { missing: true, end: '', val: 0 };
                    }
                });
                const maxVal = Math.max(...uniqueData.filter(d => !d.missing).map(d => parseFloat(d.val)));
                const minBarHeight = 16;
                const maxBarHeight = 80;
                const allEqual = uniqueData.filter(d => !d.missing).every(d => parseFloat(d.val) === parseFloat(uniqueData.filter(d2 => !d2.missing)[0]?.val));
                timelineChart.innerHTML = `
                    <div class=\"h-full flex flex-col\">
                        <h4 class=\"text-sm font-medium text-gray-700 mb-3\">${metric.name} Timeline</h4>
                        <div class=\"flex-1 flex items-end justify-around space-x-1\">
                            ${uniqueData.map((dataPoint, index) => {
                                const value = parseFloat(dataPoint.val);
                                // For real data, calculate label from end date; for missing, blank
                                let label = '';
                                if (!dataPoint.missing && dataPoint.end) {
                                    const date = new Date(dataPoint.end);
                                    const quarter = Math.ceil((date.getMonth() + 1) / 3);
                                    const year = date.getFullYear();
                                    label = `Q${quarter} ${year}`;
                                }
                                let height;
                                if (dataPoint.missing) {
                                    height = minBarHeight;
                                    return `
                                        <div class=\"flex flex-col items-center group relative\">
                                            <div class=\"w-6 bg-gray-400 border border-gray-600 rounded-t transition-colors\" style=\"height: ${height}px\" title=\"Missing data\"></div>
                                            <span class=\"text-xs text-black mt-4\">${label}</span>
                                            <div class=\"absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-2 py-1 bg-black text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap\">Missing data</div>
                                        </div>
                                    `;
                                }
                                if (allEqual) {
                                    height = maxBarHeight;
                                } else {
                                    height = Math.max((value / maxVal) * maxBarHeight, minBarHeight);
                                }
                                const date = dataPoint.end ? new Date(dataPoint.end) : null;
                                const tooltip = dataPoint.end ? `$${formatValue(dataPoint.val)}B<br>${date.toLocaleDateString()}` : 'No date';
                                return `
                                    <div class=\"flex flex-col items-center group relative\">
                                        <div class=\"w-6 bg-blue-900 border border-black rounded-t transition-colors hover:bg-blue-700\" style=\"height: ${height}px\" title=\"$${formatValue(dataPoint.val)}B\"></div>
                                        <span class=\"text-xs text-black mt-4\">${label}</span>
                                        <div class=\"absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-2 py-1 bg-black text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap\">${tooltip}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <div class=\"mt-4 text-xs text-gray-500 text-center\">Values in billions USD â€¢ Hover bars for details</div>
                    </div>
                `;
                return; // Skip the rest of the function for quarterly view
            }
            // For annual view, ensure 5 most recent consecutive years are shown, with placeholders for missing data
            if (periodType === '10-K' && validData.length > 0) {
                // Map data by year string (e.g., '2024')
                const dataByYear = {};
                validData.forEach(d => {
                    const date = new Date(d.end);
                    const year = date.getFullYear();
                    const key = `${year}`;
                    if (!dataByYear[key] || new Date(d.end) > new Date(dataByYear[key].end)) {
                        dataByYear[key] = d;
                    }
                });
                // Find the most recent year
                const allYears = Object.keys(dataByYear).map(y => parseInt(y));
                allYears.sort((a, b) => a - b);
                let mostRecent = allYears[allYears.length - 1];
                // Build the 5 most recent consecutive years
                const timeline = [];
                let y = mostRecent ? mostRecent : (new Date()).getFullYear();
                for (let i = 0; i < 5; i++) {
                    timeline.unshift({year: y});
                    y--;
                }
                // Build uniqueData array for chart, with placeholders for missing
                console.log('Timeline keys (annual):', timeline.map(({year}) => `${year}`));
                console.log('dataByYear keys:', Object.keys(dataByYear));
                const uniqueData = timeline.map(({year}) => {
                    const key = `${year}`;
                    if (dataByYear[key]) {
                        return dataByYear[key];
                    } else {
                        return { missing: true, end: '', val: 0 };
                    }
                });
                const maxVal = Math.max(...uniqueData.filter(d => !d.missing).map(d => parseFloat(d.val)));
                const minBarHeight = 16;
                const maxBarHeight = 80;
                const allEqual = uniqueData.filter(d => !d.missing).every(d => parseFloat(d.val) === parseFloat(uniqueData.filter(d2 => !d2.missing)[0]?.val));
                timelineChart.innerHTML = `
                    <div class=\"h-full flex flex-col\">
                        <h4 class=\"text-sm font-medium text-gray-700 mb-3\">${metric.name} Timeline</h4>
                        <div class=\"flex-1 flex items-end justify-around space-x-1\">
                            ${uniqueData.map((dataPoint, index) => {
                                const value = parseFloat(dataPoint.val);
                                // For real data, calculate label from end date; for missing, blank
                                let label = '';
                                if (!dataPoint.missing && dataPoint.end) {
                                    const date = new Date(dataPoint.end);
                                    const year = date.getFullYear();
                                    label = `${year}`;
                                }
                                let height;
                                if (dataPoint.missing) {
                                    height = minBarHeight;
                                    return `
                                        <div class=\"flex flex-col items-center group relative\">
                                            <div class=\"w-6 bg-gray-400 border border-gray-600 rounded-t transition-colors\" style=\"height: ${height}px\" title=\"Missing data\"></div>
                                            <span class=\"text-xs text-black mt-4\">${label}</span>
                                            <div class=\"absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-2 py-1 bg-black text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap\">Missing data</div>
                                        </div>
                                    `;
                                }
                                if (allEqual) {
                                    height = maxBarHeight;
                                } else {
                                    height = Math.max((value / maxVal) * maxBarHeight, minBarHeight);
                                }
                                const date = dataPoint.end ? new Date(dataPoint.end) : null;
                                const tooltip = dataPoint.end ? `$${formatValue(dataPoint.val)}B<br>${date.toLocaleDateString()}` : 'No date';
                                return `
                                    <div class=\"flex flex-col items-center group relative\">
                                        <div class=\"w-6 bg-blue-900 border border-black rounded-t transition-colors hover:bg-blue-700\" style=\"height: ${height}px\" title=\"$${formatValue(dataPoint.val)}B\"></div>
                                        <span class=\"text-xs text-black mt-4\">${label}</span>
                                        <div class=\"absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-2 py-1 bg-black text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap\">${tooltip}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <div class=\"mt-4 text-xs text-gray-500 text-center\">Values in billions USD â€¢ Hover bars for details</div>
                    </div>
                `;
                return; // Skip the rest of the function for annual view
            }
        }

        // Chat UI logic
        const chatBtn = document.getElementById('chat-btn');
        const chatModal = document.getElementById('chat-modal');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatMessages = document.getElementById('chat-messages');

        chatBtn.onclick = () => chatModal.classList.toggle('hidden');
        chatForm.onsubmit = async (e) => {
            e.preventDefault();
            const userMsg = chatInput.value.trim();
            if (!userMsg) return;
            chatMessages.innerHTML += `<div class="mb-1"><b>You:</b> ${userMsg}</div>`;
            chatInput.value = '';
            chatMessages.innerHTML += `<div class="mb-1 text-gray-400">Agent is typing...</div>`;
            chatMessages.scrollTop = chatMessages.scrollHeight;
            try {
                const res = await fetch('http://localhost:8001/ask', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({question: userMsg})
                });
                const data = await res.json();
                chatMessages.innerHTML += `<div class="mb-2"><b>Agent:</b> ${data.answer}</div>`;
            } catch (err) {
                chatMessages.innerHTML += `<div class="mb-2 text-red-600"><b>Agent:</b> Error connecting to backend.</div>`;
            }
            chatMessages.scrollTop = chatMessages.scrollHeight;
        };

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboard();
            setupEventHandlers();
            showOverviewContent(); // Initialize with overview
        });
    </script>
</body>
</html> 
