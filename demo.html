<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apple Financial Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <div id="dashboard-container" class="p-3 sm:p-4 lg:p-6 min-h-screen">
        <!-- Loading State -->
        <div id="loading" class="flex items-center justify-center min-h-screen">
            <div class="text-center">
                <div class="animate-spin rounded-full h-8 w-8 sm:h-12 sm:w-12 border-b-2 border-blue-600 mx-auto mb-2 sm:mb-4"></div>
                <p class="text-sm sm:text-base text-gray-600">Loading Apple Financial Data...</p>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboard" class="hidden">
            <!-- Header -->
            <div class="mb-4 sm:mb-6 lg:mb-8">
                <div style="display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 1.5rem;">
                    <div style="flex: 1 1 300px; min-width: 220px;">
                        <h1 style="font-size:2rem;font-weight:700;color:#111827;display:flex;align-items:center;gap:0.5rem;margin-bottom:0.5rem;">
                            Apple Inc. Financial Dashboard - Real Data
                            <span class="relative group align-middle">
                                <i data-lucide="info" style="font-size:1.1rem;color:#2563eb;cursor:pointer;"></i>
                                <div class="custom-tooltip">
                                    <div class="custom-tooltip-arrow">
                                        <svg width='16' height='8'><polygon points='0,8 8,0 16,8' style='fill:#222;'/></svg>
                                    </div>
                                    <div>
                                        <strong>Annual View</strong>
                                        <div class="text-sm" style="margin-bottom: 10px;">
                                            Shows the latest available 10-K (annual report) for each metric.
                                        </div>
                                        <strong>Latest View</strong>
                                        <div class="text-sm">
                                            Shows the most recent 10-Q (quarterly report) for each metric.<br>
                                            If a 10-K is not available for the current year, the most recent prior 10-K is shown.
                                        </div>
                                    </div>
                                </div>
                            </span>
                        </h1>
                        <p style="color:#6b7280;font-size:1rem;">SEC Filing Data Analysis - Real-time EDGAR API Data</p>
                    </div>
                    <div style="display:flex;align-items:center;gap:1.25rem;flex-wrap:wrap;">
                        <div style="display:flex;align-items:center;gap:0.5rem;">
                            <label for="period-selector" style="font-size:1rem;font-weight:500;color:#374151;display:flex;align-items:center;gap:0.25rem;">Period:
                                <span class="relative group align-middle">
                                    <i data-lucide="info" style="font-size:1.1rem;color:#2563eb;cursor:pointer;"></i>
                                    <div class="custom-tooltip">
                                        <div class="custom-tooltip-arrow">
                                            <svg width='16' height='8'><polygon points='0,8 8,0 16,8' style='fill:#222;'/></svg>
                                        </div>
                                        <div>
                                            <strong>Annual View</strong>
                                            <div class="text-sm" style="margin-bottom: 10px;">
                                                Shows the latest available 10-K (annual report) for each metric.
                                            </div>
                                            <strong>Latest View</strong>
                                            <div class="text-sm">
                                                Shows the most recent 10-Q (quarterly report) for each metric.<br>
                                                If a 10-K is not available for the current year, the most recent prior 10-K is shown.
                                            </div>
                                        </div>
                                    </div>
                                </span>
                            </label>
                            <select id="period-selector" style="margin-left:0.5rem;min-width:110px;" class="">
                                <option value="latest">Latest</option>
                                <option value="annual">Annual</option>
                            </select>
                        </div>
                        <div style="display:flex;align-items:center;gap:0.5rem;">
                            <button id="overview-btn" class="primary-btn" style="padding:0.5rem 1.25rem;font-size:1rem;border-radius:0.75rem;margin-right:0.25rem;">Overview</button>
                            <button id="detailed-btn" class="secondary-btn" style="padding:0.5rem 1.25rem;font-size:1rem;border-radius:0.75rem;">Detailed</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary Cards -->
            <div id="summary-cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 lg:gap-6 mb-6 lg:mb-8">
                <!-- Cards will be populated by JavaScript using <div class='card'> ... </div> -->
            </div>

            <!-- Charts Section -->
            <div id="charts-section" class="grid grid-cols-1 lg:grid-cols-2 gap-4 lg:gap-8 mb-6 lg:mb-8">
                <!-- Financial Trends Chart -->
                <div class="chart-container">
                    <h3>Financial Performance Trends</h3>
                    <div id="trends-chart" style="height: 15rem; min-height: 200px;"></div>
                </div>

                <!-- Growth Analysis Chart -->
                <div class="chart-container">
                    <h3>Growth Rate Analysis</h3>
                    <div id="growth-chart" style="height: 15rem; min-height: 200px;"></div>
                </div>
            </div>

            <!-- Key Financial Ratios -->
            <div class="card mb-6 lg:mb-8">
                <h3>Key Financial Insights</h3>
                <div id="financial-ratios" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 lg:gap-6">
                    <!-- Ratios will be populated by JavaScript using <div class='card'> ... </div> -->
                </div>
            </div>

            <!-- Data Source Information -->
            <div class="card">
                <h3>Data Source & Quality</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="flex items-center">
                        <i data-lucide="check-circle" style="font-size:1.5rem;color:#16a34a;margin-right:1rem;"></i>
                        <div>
                            <p style="color:#16a34a;font-weight:500;">SEC EDGAR Database</p>
                            <p id="data-source-note" style="color:#22c55e;">Official 10-K & 10-Q Filings</p>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <i data-lucide="calendar" style="font-size:1.5rem;color:#2563eb;margin-right:1rem;"></i>
                        <div>
                            <p style="color:#2563eb;font-weight:500;">Data Freshness</p>
                            <p id="last-updated" style="color:#60a5fa;">Updated: Loading...</p>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <i data-lucide="lightbulb" style="font-size:1.5rem;color:#a21caf;margin-right:1rem;"></i>
                        <div>
                            <p style="color:#a21caf;font-weight:500;">GAAP Compliant</p>
                            <p style="color:#c084fc;">US-GAAP Standard Metrics</p>
                        </div>
                    </div>
                </div>
                <div style="margin-top:1rem;padding:1rem;background:#f3f4f6;border-radius:0.75rem;">
                    <p style="color:#6b7280;font-size:0.95rem;">
                        <strong>Note:</strong> All financial data is sourced directly from Apple Inc.'s SEC filings using the EDGAR API. 
                        Values are presented in billions of USD. Growth rates are calculated year-over-year based on the most recent 
                        comparable periods available in the filings.
                    </p>
                </div>
            </div>

            <!-- Footer -->
            <div class="mt-6 lg:mt-8 pt-4 lg:pt-6 border-t border-gray-200">
                <p class="text-xs lg:text-sm text-gray-500">
                    Generated for Apple Sales & Finance teams | Data Source: SEC EDGAR API | 
                    Company CIK: 0000320193 | Generated: <span id="generated-date"></span>
                </p>
            </div>
        </div>
    </div>

    <!-- Chat Button and Modal -->
    <button id="chat-btn" class="primary-btn fixed bottom-4 right-4 sm:bottom-6 sm:right-6 rounded-full p-3 sm:p-4 shadow-lg z-50" style="font-size:1.5rem;line-height:1;">
        ðŸ’¬
    </button>
    <div id="chat-modal" class="fixed bottom-16 right-4 sm:bottom-24 sm:right-6 w-[calc(100%-2rem)] sm:w-80 bg-white rounded-xl shadow-lg border border-gray-200 p-3 sm:p-4 z-50 hidden">
        <div id="chat-messages" class="h-40 sm:h-48 overflow-y-auto mb-2 text-xs sm:text-sm"></div>
        <form id="chat-form" class="flex gap-2">
            <input id="chat-input" type="text" class="flex-1 border rounded-lg px-2 py-1 text-sm" placeholder="Ask about the dashboard..." autocomplete="off" />
            <button type="submit" class="primary-btn" style="padding:0.5rem 1.25rem;font-size:1rem;border-radius:0.75rem;">Send</button>
        </form>
    </div>

    <!-- Single tooltip element that will be moved around -->
    <div id="tooltip" class="fixed px-2 sm:px-3 py-1 sm:py-2 bg-black text-white text-xs rounded shadow-lg" style="display: none; z-index: 9999;">
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Load and display SEC data
        async function loadDashboard() {
            try {
                // Load SEC data
                const response = await fetch('./apple_sec_dashboard_data.json');
                const secData = await response.json();
                
                // Hide loading, show dashboard
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                
                // Store data globally for detailed view
                globalSecData = secData;
                
                // Populate dashboard with data
                populateSummaryCards(secData);
                populateFinancialRatios(secData);
                updateTimestamps(secData);
                
                // Update overview content if we're in overview mode
                if (currentView === 'overview') {
                    showOverviewContent();
                }
                
                console.log('Dashboard loaded successfully with SEC data');
                
            } catch (error) {
                console.error('Error loading SEC data:', error);
                
                // Show error state or fallback data
                document.getElementById('loading').innerHTML = `
                    <div class="text-center">
                        <i data-lucide="alert-circle" class="h-12 w-12 text-red-600 mx-auto mb-4"></i>
                        <p class="text-gray-600">Error loading financial data</p>
                        <p class="text-sm text-gray-500 mt-2">Please ensure apple_sec_dashboard_data.json is available</p>
                    </div>
                `;
                lucide.createIcons();
            }
        }

        function formatValue(value) {
            const numValue = typeof value === 'string' ? parseFloat(value) : value;
            return (numValue / 1000000000).toFixed(1); // Convert to billions
        }

        function getCurrentFiscalInfo() {
            // Apple's fiscal year ends on the last Saturday of September
            const today = new Date();
            const year = today.getFullYear();
            let fiscalYear = year;
            if (today.getMonth() < 9) { // Jan=0, Sep=9
                fiscalYear = year;
            } else {
                fiscalYear = year + 1;
            }
            // Determine fiscal quarter
            // Q1: Oct-Dec, Q2: Jan-Mar, Q3: Apr-Jun, Q4: Jul-Sep
            let fiscalQuarter = 1;
            const m = today.getMonth();
            if (m >= 0 && m <= 2) fiscalQuarter = 2;
            else if (m >= 3 && m <= 5) fiscalQuarter = 3;
            else if (m >= 6 && m <= 8) fiscalQuarter = 4;
            else if (m >= 9 && m <= 11) fiscalQuarter = 1;

            // Fiscal year start: October 1 of previous year if before October, otherwise this year
            let fiscalYearStartYear = fiscalYear - 1;
            let fiscalYearStart = new Date(fiscalYearStartYear, 9, 1); // October 1

            // Fiscal year end: last Saturday of September of fiscalYear
            let lastDayOfSeptember = new Date(fiscalYear, 8, 30); // Sep 30
            // Find last Saturday
            let fiscalYearEnd = new Date(lastDayOfSeptember);
            while (fiscalYearEnd.getDay() !== 6) { // 6 = Saturday
                fiscalYearEnd.setDate(fiscalYearEnd.getDate() - 1);
            }
            return {
                fiscalYear,
                fiscalQuarter,
                fiscalYearStart,
                fiscalYearEnd
            };
        }

        function populateSummaryCards(secData) {
            const currentMetrics = getMetricsForPeriod(secData, currentPeriod);
            const currentYear = new Date().getFullYear();
            const { fiscalYear, fiscalQuarter, fiscalYearStart, fiscalYearEnd } = getCurrentFiscalInfo();
            const fiscalYearStartStr = fiscalYearStart.toLocaleString('default', { month: 'long', year: 'numeric' });
            const fiscalYearEndStr = fiscalYearEnd.toLocaleString('default', { month: 'long', year: 'numeric' });
            const summaryCards = [
                {
                    key: 'revenue',
                    title: 'Total Revenue',
                    ...getValuePeriodForm(currentMetrics.revenue),
                    growth: currentPeriod === 'quarterly' ? 
                        (currentMetrics.revenue?.quarterly_vs_annual_change ?? 0) : 
                        (currentMetrics.revenue?.growth_rate ?? 0),
                    icon: 'dollar-sign',
                    color: 'text-green-600',
                    bgColor: 'bg-green-50',
                    showInfo: currentMetrics.revenue?.latest_year !== currentYear
                },
                {
                    key: 'net_income',
                    title: 'Net Income',
                    ...getValuePeriodForm(currentMetrics.net_income),
                    growth: currentPeriod === 'quarterly' ? 
                        (currentMetrics.net_income?.quarterly_vs_annual_change ?? 0) : 
                        (currentMetrics.net_income?.growth_rate ?? 0),
                    icon: 'target',
                    color: 'text-blue-600',
                    bgColor: 'bg-blue-50',
                    showInfo: currentMetrics.net_income?.latest_year !== currentYear
                },
                {
                    key: 'total_assets',
                    title: 'Total Assets',
                    ...getValuePeriodForm(currentMetrics.total_assets),
                    growth: currentPeriod === 'quarterly' ? 
                        (currentMetrics.total_assets?.quarterly_vs_annual_change ?? 0) : 
                        (currentMetrics.total_assets?.growth_rate ?? 0),
                    icon: 'building',
                    color: 'text-purple-600',
                    bgColor: 'bg-purple-50',
                    showInfo: currentMetrics.total_assets?.latest_year !== currentYear
                },
                {
                    key: 'cash_and_equivalents',
                    title: 'Cash & Equivalents',
                    ...getValuePeriodForm(currentMetrics.cash_and_equivalents),
                    growth: currentPeriod === 'quarterly' ? 
                        (currentMetrics.cash_and_equivalents?.quarterly_vs_annual_change ?? 0) : 
                        (currentMetrics.cash_and_equivalents?.growth_rate ?? 0),
                    icon: 'piggy-bank',
                    color: 'text-yellow-600',
                    bgColor: 'bg-yellow-50',
                    showInfo: currentMetrics.cash_and_equivalents?.latest_year !== currentYear
                }
            ];

            const cardsContainer = document.getElementById('summary-cards');
            cardsContainer.innerHTML = summaryCards.map(card => `
                <div class="card">
                    <div style="display:flex;align-items:center;justify-content:space-between;">
                        <div>
                            <p class="summary-title">${card.title}</p>
                            <p class="summary-value">$${card.value}B</p>
                            ${card.period ? `<p style="color:#6b7280;font-size:0.95rem;margin-top:0.25rem;">${card.form} â€¢ ${new Date(card.period).toLocaleDateString()}</p>` : ''}
                        </div>
                        <div style="padding:0.75rem;border-radius:0.75rem;background:#f3f4f6;">
                            <i data-lucide="${card.icon}" class="summary-icon" style="color:#2563eb;"></i>
                        </div>
                    </div>
                    <div style="display:flex;align-items:center;margin-top:0.75rem;">
                        <i data-lucide="${card.growth >= 0 ? 'trending-up' : 'trending-down'}" 
                           style="font-size:1.1rem;color:${card.growth >= 0 ? '#16a34a' : '#dc2626'};"></i>
                        <span style="margin-left:0.5rem;font-size:1rem;font-weight:500;color:${card.growth >= 0 ? '#16a34a' : '#dc2626'};">
                            ${card.growth >= 0 ? '+' : ''}${card.growth.toFixed(1)}%
                        </span>
                        <span style="margin-left:0.75rem;font-size:0.95rem;color:#6b7280;">${currentPeriod === 'quarterly' ? 'vs Annual' : 'YoY'}</span>
                    </div>
                </div>
            `).join('');

            // Reinitialize icons
            lucide.createIcons();
        }

        function getValuePeriodForm(metric) {
            // Always match value, period, and form from the same source
            if (!metric) return { value: '0', period: '', form: '' };
            // Prefer latest_value, fallback to latest_quarterly_value
            if (metric.latest_value) {
                return {
                    value: formatValue(metric.latest_value),
                    period: metric.latest_period || '',
                    form: metric.latest_form || ''
                };
            } else if (metric.latest_quarterly_value) {
                return {
                    value: formatValue(metric.latest_quarterly_value),
                    period: metric.latest_quarterly_period || '',
                    form: '10-Q'
                };
            }
            return { value: '0', period: '', form: '' };
        }

        function populateFinancialRatios(secData) {
            const currentMetrics = getMetricsForPeriod(secData, currentPeriod);
            const revenue = parseFloat(currentMetrics.revenue?.latest_value || currentMetrics.revenue?.latest_quarterly_value || 0);
            const netIncome = parseFloat(currentMetrics.net_income?.latest_value || currentMetrics.net_income?.latest_quarterly_value || 0);
            const totalAssets = parseFloat(currentMetrics.total_assets?.latest_value || currentMetrics.total_assets?.latest_quarterly_value || 0);
            const cash = parseFloat(currentMetrics.cash_and_equivalents?.latest_value || currentMetrics.cash_and_equivalents?.latest_quarterly_value || 0);

            const profitMargin = revenue > 0 ? ((netIncome / revenue) * 100).toFixed(1) : '0.0';
            const roa = totalAssets > 0 ? ((netIncome / totalAssets) * 100).toFixed(1) : '0.0';
            const cashRatio = totalAssets > 0 ? ((cash / totalAssets) * 100).toFixed(1) : '0.0';

            const ratiosContainer = document.getElementById('financial-ratios');
            ratiosContainer.innerHTML = `
                <div class="text-center p-4 rounded-lg shadow-sm border border-gray-200">
                    <div class="text-2xl font-bold text-blue-600">${profitMargin}%</div>
                    <div class="text-sm text-gray-600 mt-1 flex items-center justify-center gap-1">
                        Net Profit Margin
                        ${renderInfoIconWithTooltip('Net Profit Margin = Net Income / Revenue')}
                    </div>
                </div>
                <div class="text-center p-4 rounded-lg shadow-sm border border-gray-200">
                    <div class="text-2xl font-bold text-green-600">${roa}%</div>
                    <div class="text-sm text-gray-600 mt-1 flex items-center justify-center gap-1">
                        Return on Assets
                        ${renderInfoIconWithTooltip('Return on Assets = Net Income / Total Assets')}
                    </div>
                </div>
                <div class="text-center p-4 rounded-lg shadow-sm border border-gray-200">
                    <div class="text-2xl font-bold text-purple-600">${cashRatio}%</div>
                    <div class="text-sm text-gray-600 mt-1 flex items-center justify-center gap-1">
                        Cash Ratio
                        ${renderInfoIconWithTooltip('Cash Ratio = Cash & Equivalents / Total Assets')}
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function updateTimestamps(secData) {
            const lastUpdated = new Date(secData.last_updated).toLocaleDateString();
            const generatedDate = new Date().toLocaleDateString();
            
            document.getElementById('last-updated').textContent = `Updated: ${lastUpdated}`;
            document.getElementById('generated-date').textContent = generatedDate;
        }

        // View mode state
        let currentView = 'overview';
        let currentPeriod = 'latest';
        let globalSecData = null;

        // Button event handlers
        function setupEventHandlers() {
            document.getElementById('overview-btn').addEventListener('click', function() {
                switchView('overview');
                document.getElementById('overview-btn').className = 'primary-btn';
                document.getElementById('detailed-btn').className = 'secondary-btn';
            });
            
            document.getElementById('detailed-btn').addEventListener('click', function() {
                switchView('detailed');
                document.getElementById('overview-btn').className = 'secondary-btn';
                document.getElementById('detailed-btn').className = 'primary-btn';
            });
            
            document.getElementById('period-selector').addEventListener('change', function(e) {
                switchPeriod(e.target.value);
            });
        }

        function switchView(view) {
            currentView = view;
            
            // Update button styles
            const overviewBtn = document.getElementById('overview-btn');
            const detailedBtn = document.getElementById('detailed-btn');
            
            if (view === 'overview') {
                overviewBtn.className = 'primary-btn';
                detailedBtn.className = 'secondary-btn';
                showOverviewContent();
            } else {
                overviewBtn.className = 'secondary-btn';
                detailedBtn.className = 'primary-btn';
                showDetailedContent();
            }
        }

        function switchPeriod(period) {
            currentPeriod = period;
            
            if (!globalSecData) return;
            
            // Update summary cards with selected period data
            populateSummaryCards(globalSecData);
            populateFinancialRatios(globalSecData);
            
            // Update content based on current view
            if (currentView === 'overview') {
                showOverviewContent();
            } else {
                showDetailedContent();
            }
            
            // Update the data source information
            updateDataSourceInfo(period);
        }

        function getMetricsForPeriod(secData, period) {
            switch(period) {
                case 'annual': {
                    // Only show the latest 10-K for all metrics
                    const annualMetrics = {};
                    for (const [key, data] of Object.entries(secData.summary_metrics)) {
                        if (data.latest_form === '10-K') {
                            annualMetrics[key] = data;
                        } else {
                            // If no annual data, try to find it from raw metrics
                            const rawMetric = secData.raw_metrics[key];
                            if (rawMetric && rawMetric.annual_data && rawMetric.annual_data.length > 0) {
                                const latestAnnual = rawMetric.annual_data[rawMetric.annual_data.length - 1];
                                annualMetrics[key] = {
                                    ...data,
                                    latest_value: latestAnnual.val,
                                    latest_year: latestAnnual.fy,
                                    latest_period: latestAnnual.end,
                                    latest_form: latestAnnual.form
                                };
                            }
                        }
                    }
                    return annualMetrics;
                }
                case 'latest':
                default:
                    return secData.summary_metrics;
            }
        }

        function updateDataSourceInfo(period) {
            const dataSourceText = {
                'latest': 'Latest Available Data (Quarterly & Annual)',
                'annual': 'Annual Reports (10-K)'
            };
            
            const noteElement = document.querySelector('#data-source-note');
            if (noteElement) {
                noteElement.textContent = dataSourceText[period] || dataSourceText['latest'];
            }
        }

        function showOverviewContent() {
            if (!globalSecData) {
                document.getElementById('charts-section').innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 col-span-2">
                        <div class="text-center text-gray-500">
                            <i data-lucide="loader" class="h-16 w-16 mx-auto mb-4 text-blue-500 animate-spin"></i>
                            <p class="font-medium">Loading financial data...</p>
                        </div>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            // Use the same metrics as the top row for consistency
            const metrics = getMetricsForPeriod(globalSecData, currentPeriod);
            const growthAnalysis = globalSecData.growth_analysis || [];

            document.getElementById('charts-section').innerHTML = `
                <!-- Financial Performance Overview -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Financial Performance Overview</h3>
                    <div class="h-80 flex flex-col justify-center">
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="text-center p-4 bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg">
                                <div class="text-2xl font-bold text-blue-600">$${formatValue(metrics.revenue?.latest_value || 0)}B</div>
                                <div class="text-sm text-blue-800">Total Revenue</div>
                                <div class="text-xs text-gray-600 mt-1">FY ${metrics.revenue?.latest_year || 'N/A'}</div>
                            </div>
                            <div class="text-center p-4 bg-gradient-to-br from-green-50 to-green-100 rounded-lg">
                                <div class="text-2xl font-bold text-green-600">$${formatValue(metrics.net_income?.latest_value || 0)}B</div>
                                <div class="text-sm text-green-800">Net Income</div>
                                <div class="text-xs text-gray-600 mt-1">FY ${metrics.net_income?.latest_year || 'N/A'}</div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3">
                            <div class="text-center p-3 bg-gray-50 rounded">
                                <div class="text-lg font-bold text-gray-700">$${formatValue(metrics.operating_income?.latest_value || 0)}B</div>
                                <div class="text-xs text-gray-600">Operating Income</div>
                            </div>
                            <div class="text-center p-3 bg-gray-50 rounded">
                                <div class="text-lg font-bold text-gray-700">$${formatValue(metrics.research_development?.latest_value || 0)}B</div>
                                <div class="text-xs text-gray-600">R&D Investment</div>
                            </div>
                            <div class="text-center p-3 bg-gray-50 rounded">
                                <div class="text-lg font-bold text-gray-700">$${formatValue(metrics.cash_and_equivalents?.latest_value || 0)}B</div>
                                <div class="text-xs text-gray-600">Cash Position</div>
                            </div>
                        </div>
                        
                        <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                            <div class="text-sm text-blue-800 text-center">
                                <strong>Market Position:</strong> Apple maintains strong financial fundamentals with 
                                $${formatValue(metrics.total_assets?.latest_value || 0)}B in total assets and consistent profitability.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Live Growth Rate Analysis -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Year-over-Year Growth Analysis</h3>
                    <div class="h-80 overflow-hidden">
                        <div class="space-y-2 h-full overflow-y-auto pr-2">
                            ${Object.entries(metrics).map(([key, metric]) => {
                                const growthRate = metric.growth_rate || 0;
                                const isPositive = growthRate >= 0;
                                return `
                                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                                        <div class="flex items-center min-w-0 flex-1">
                                            <i data-lucide="${isPositive ? 'trending-up' : 'trending-down'}" 
                                               class="h-4 w-4 ${isPositive ? 'text-green-600' : 'text-red-600'} mr-2 flex-shrink-0"></i>
                                            <span class="font-medium text-gray-800 truncate">${metric.name}</span>
                                        </div>
                                        <div class="flex items-center ml-4 flex-shrink-0">
                                            <div class="text-right">
                                                <div class="text-sm font-medium text-gray-900">$${formatValue(metric.latest_value)}B</div>
                                                <div class="text-sm font-bold ${isPositive ? 'text-green-600' : 'text-red-600'}">
                                                    ${isPositive ? '+' : ''}${growthRate.toFixed(1)}%
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <div class="mt-4 p-3 bg-gradient-to-r from-green-50 to-blue-50 rounded-lg">
                            <div class="text-sm text-gray-700 text-center">
                                <i data-lucide="info" class="h-4 w-4 inline mr-2 text-blue-600"></i>
                                Growth calculated from SEC 10-K filings
                            </div>
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function showDetailedContent() {
            document.getElementById('charts-section').innerHTML = `
                <!-- Metric Selector -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 col-span-2">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Detailed Financial Analysis</h3>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Metric for Analysis</label>
                        <select id="metric-selector" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="revenue">Total Revenue</option>
                            <option value="net_income">Net Income</option>
                            <option value="operating_income">Operating Income</option>
                            <option value="total_assets">Total Assets</option>
                            <option value="cash_and_equivalents">Cash & Equivalents</option>
                            <option value="research_development">Research & Development</option>
                        </select>
                    </div>
                    <div id="timeline-chart" class="h-64 bg-gray-50 rounded-lg p-4">
                        <div class="text-center text-gray-500 flex flex-col items-center justify-center h-full">
                            <i data-lucide="bar-chart-3" class="h-12 w-12 mx-auto mb-2 text-blue-500"></i>
                            <p class="font-medium">Historical Data Timeline</p>
                            <p class="text-sm">Select a metric to view historical trends</p>
                        </div>
                    </div>
                </div>

                <!-- Metric Details -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 col-span-2">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Metric Details</h3>
                    <div id="metric-details" class="space-y-4">
                        <div class="grid grid-cols-3 gap-4">
                            <div class="p-4 bg-blue-50 rounded-lg">
                                <p class="text-sm text-gray-600">Latest Value</p>
                                <p class="text-xl font-bold text-blue-600" id="latest-value">Select a metric</p>
                                <p class="text-xs text-gray-500" id="latest-year">--</p>
                            </div>
                            <div class="p-4 bg-green-50 rounded-lg">
                                <p class="text-sm text-gray-600">Growth Rate</p>
                                <p class="text-xl font-bold" id="growth-rate">--</p>
                                <p class="text-xs text-gray-500">Year over Year</p>
                            </div>
                            <div class="p-4 bg-purple-50 rounded-lg" id="quarterly-comparison" style="display: none;">
                                <p class="text-sm text-gray-600">Q vs Annual</p>
                                <p class="text-xl font-bold" id="quarterly-change">--</p>
                                <p class="text-xs text-gray-500">Latest Quarter vs Annual</p>
                            </div>
                        </div>
                        <div class="p-4 bg-gray-50 rounded-lg">
                            <p class="text-sm text-gray-600 mb-2">Historical Context</p>
                            <p class="text-sm" id="historical-context">Select a metric above to view detailed analysis and historical trends from SEC 10-K filings.</p>
                        </div>
                        <div id="historical-data" class="mt-4">
                            <!-- Historical data points will be shown here -->
                        </div>
                    </div>
                </div>
            `;
            
            // Add event listener for metric selector
            document.getElementById('metric-selector').addEventListener('change', function(e) {
                updateMetricDetails(e.target.value);
            });
            
            lucide.createIcons();
            
            // Load initial metric (revenue)
            updateMetricDetails('revenue');
        }

        function updateMetricDetails(metricKey) {
            if (!globalSecData) return;
            const metric = globalSecData.summary_metrics[metricKey];
            if (!metric) return;
            const latestValue = formatValue(metric.latest_value);
            const growthRate = metric.growth_rate;
            const latestYear = metric.latest_year;
            const quarterlyMetric = globalSecData.quarterly_metrics[metricKey];
            const quarterlyChange = quarterlyMetric && quarterlyMetric.quarterly_vs_annual_change !== undefined ? quarterlyMetric.quarterly_vs_annual_change : null;

            // Defensive: Ensure rawMetric.data is a valid array of objects with numeric val
            const rawMetric = globalSecData.raw_metrics[metricKey];
            let validData = [];
            if (rawMetric && Array.isArray(rawMetric.data)) {
                validData = rawMetric.data.filter(d => d && !isNaN(parseFloat(d.val)) && d.end);
            }

            // Render the metric details section (cards, context, historical data)
            document.getElementById('metric-details').innerHTML = `
              <div class="grid grid-cols-3 gap-4">
                <div class="p-4 bg-blue-50 rounded-lg">
                  <p class="text-sm text-gray-600">Latest Value</p>
                  <p class="text-xl font-bold text-blue-600">$${latestValue}B</p>
                  <p class="text-xs text-gray-500">${metric.latest_form} ${latestYear}</p>
                </div>
                <div class="p-4 bg-green-50 rounded-lg">
                  <div class="flex items-center gap-1">
                    <span class="text-sm text-gray-600">Growth Rate</span>
                    ${renderInfoIconWithTooltip('Growth Rate = Year-over-year growth, comparing the latest annual value to the previous year.')}
                  </div>
                  <p class="text-xl font-bold ${growthRate >= 0 ? 'text-green-600' : 'text-red-600'}">${growthRate >= 0 ? '+' : ''}${growthRate.toFixed(1)}%</p>
                  <p class="text-xs text-gray-500">Year over Year</p>
                </div>
                <div class="p-4 bg-purple-50 rounded-lg" id="quarterly-comparison" style="${quarterlyChange !== null ? '' : 'display: none;'}">
                  <div class="flex items-center gap-1">
                    <span class="text-sm text-gray-600">Q vs Annual</span>
                    ${renderInfoIconWithTooltip('Q vs Annual = Compares the latest quarter to the most recent annual value.')}
                  </div>
                  <p class="text-xl font-bold">${quarterlyChange !== null ? (quarterlyChange >= 0 ? '+' : '') + quarterlyChange.toFixed(1) + '%' : '--'}</p>
                  <p class="text-xs text-gray-500">Latest Quarter vs Annual</p>
                </div>
              </div>
              <div class="p-4 bg-gray-50 rounded-lg mt-4">
                <p class="text-sm text-gray-600 mb-2">Historical Context</p>
                <p class="text-sm" id="historical-context"></p>
              </div>
              <div id="historical-data" class="mt-4"></div>
            `;
            lucide.createIcons();

            // Update historical context
            const contextMessages = {
                'revenue': 'Apple\'s revenue shows significant quarterly variations due to seasonal product launches, particularly iPhone releases in Q1.',
                'net_income': 'Net income reflects Apple\'s strong profitability and efficient cost management across all product lines.',
                'operating_income': 'Operating income demonstrates Apple\'s core business performance before financing and tax considerations.',
                'total_assets': 'Total assets include cash reserves, investments, property, and intellectual property portfolios.',
                'cash_and_equivalents': 'Apple maintains substantial cash reserves for strategic investments and shareholder returns.',
                'research_development': 'R&D spending reflects Apple\'s commitment to innovation across hardware, software, and services.'
            };
            document.getElementById('historical-context').textContent = contextMessages[metricKey] || 'Historical data from SEC 10-K filings.';

            // Show historical data points if available
            const historicalHtml = `
                <h4 class="text-sm font-medium text-gray-700 mb-3">Recent Historical Data</h4>
                <div class="space-y-2 max-h-32 overflow-y-auto">
                    ${validData.length > 0 ? (() => {
                        // Sort by end date ascending
                        const sorted = validData
                            .map(d => ({...d, dateObj: new Date(d.end)}))
                            .sort((a, b) => a.dateObj - b.dateObj)
                            .slice(-5); // Last 5 sorted data points
                        return sorted.map((dataPoint, idx, arr) => {
                            const date = new Date(dataPoint.end);
                            const quarter = Math.ceil((date.getMonth() + 1) / 3);
                            const year = date.getFullYear();
                            const dateLabel = `Q${quarter} ${year}`;
                            const fullDate = date.toLocaleDateString();
                            const value = parseFloat(dataPoint.val);
                            // Calculate trend vs previous value
                            let trendHtml = '';
                            if (idx > 0) {
                                const prevValue = parseFloat(arr[idx-1].val);
                                if (!isNaN(prevValue) && prevValue !== 0) {
                                    const change = ((value - prevValue) / Math.abs(prevValue)) * 100;
                                    const isUp = change >= 0;
                                    trendHtml = `<span class="ml-2 text-sm font-medium ${isUp ? 'text-green-600' : 'text-red-600'}"><i data-lucide="${isUp ? 'trending-up' : 'trending-down'}" class="inline h-4 w-4 ${isUp ? 'text-green-600' : 'text-red-600'}"></i>${isUp ? '+' : ''}${change.toFixed(1)}%</span>`;
                                }
                            }
                            // Show form type (10-Q or 10-K)
                            const formType = dataPoint.form ? `<span class="ml-2 px-2 py-0.5 rounded bg-gray-100 text-xs text-gray-700 border">${dataPoint.form}</span>` : '';
                            return `
                                <div class="flex justify-between items-center p-2 bg-white rounded border">
                                    <div class="flex flex-col">
                                        <span class="text-sm text-gray-600 font-medium">${dateLabel}</span>
                                        <span class="text-xs text-gray-500">${fullDate}</span>
                                    </div>
                                    <span class="text-sm font-medium">$${formatValue(dataPoint.val)}B${trendHtml}${formType}</span>
                                </div>
                            `;
                        }).join('');
                    })() : 'No historical data available'}
                </div>
            `;
            document.getElementById('historical-data').innerHTML = historicalHtml;

            // Render the timeline bar chart for the last 5 periods
            const timelineChart = document.getElementById('timeline-chart');
            if (validData.length > 0) {
                // Sort by end date ascending
                const sorted = validData
                    .map(d => ({...d, dateObj: new Date(d.end)}))
                    .sort((a, b) => a.dateObj - b.dateObj)
                    .slice(-5); // Last 5 sorted data points
                // Calculate bar heights
                const maxVal = Math.max(...sorted.map(d => parseFloat(d.val)));
                const minBarHeight = 16;
                const maxBarHeight = 80;
                const allEqual = sorted.every(d => parseFloat(d.val) === parseFloat(sorted[0].val));
                timelineChart.innerHTML = `
                    <div class="h-full flex flex-col">
                        <h4 class="text-sm font-medium text-gray-700 mb-3">${metric.name} Timeline</h4>
                        <div class="flex-1 flex items-end justify-around space-x-1">
                            ${sorted.map((dataPoint, index) => {
                                const value = parseFloat(dataPoint.val);
                                // For real data, calculate label from end date
                                let label = '';
                                let valueLabel = '';
                                let dateLabel = '';
                                if (dataPoint.end) {
                                    const date = new Date(dataPoint.end);
                                    const quarter = Math.ceil((date.getMonth() + 1) / 3);
                                    const year = date.getFullYear();
                                    label = `Q${quarter} ${year}`;
                                    valueLabel = `$${formatValue(dataPoint.val)}B`;
                                    dateLabel = date.toLocaleDateString();
                                }
                                let height;
                                if (allEqual) {
                                    height = maxBarHeight;
                                } else {
                                    height = Math.max((value / maxVal) * maxBarHeight, minBarHeight);
                                }
                                // Custom tooltip HTML
                                const tooltipHtml = `
                                  <div class="custom-tooltip absolute left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-black text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-10" style="bottom: 100%; min-width: 120px;">
                                    <div class="custom-tooltip-arrow"><svg width='16' height='8'><polygon points='0,8 8,0 16,8' style='fill:#222;'/></svg></div>
                                    <div><strong>${valueLabel}</strong></div>
                                    <div>${dateLabel}</div>
                                  </div>
                                `;
                                return `
                                    <div class="flex flex-col items-center group relative">
                                        <div class="w-6 bg-blue-900 border border-black rounded-t transition-colors hover:bg-blue-700" style="height: ${height}px"></div>
                                        <span class="text-xs text-black mt-4">${label}</span>
                                        <span class="text-xs text-black">${valueLabel}</span>
                                        <span class="text-xs text-gray-500">${dateLabel}</span>
                                        ${tooltipHtml}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <div class="mt-4 text-xs text-gray-500 text-center">Values in billions USD â€¢ Hover bars for details</div>
                    </div>
                `;
            } else {
                timelineChart.innerHTML = `
                    <div class="text-center text-gray-500 flex flex-col items-center justify-center h-full">
                        <i data-lucide="bar-chart-3" class="h-12 w-12 mx-auto mb-2 text-blue-500"></i>
                        <p class="font-medium">Historical Data Timeline</p>
                        <p class="text-sm">No data available for this metric</p>
                    </div>
                `;
            }
            lucide.createIcons();
        }

        // Chat UI logic
        const chatBtn = document.getElementById('chat-btn');
        const chatModal = document.getElementById('chat-modal');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatMessages = document.getElementById('chat-messages');

        chatBtn.onclick = () => chatModal.classList.toggle('hidden');
        chatForm.onsubmit = async (e) => {
            e.preventDefault();
            const userMsg = chatInput.value.trim();
            if (!userMsg) return;
            chatMessages.innerHTML += `<div class="mb-1"><b>You:</b> ${userMsg}</div>`;
            chatInput.value = '';
            chatMessages.innerHTML += `<div class="mb-1 text-gray-400">Agent is typing...</div>`;
            chatMessages.scrollTop = chatMessages.scrollHeight;
            try {
                const res = await fetch('http://localhost:8001/ask', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({question: userMsg})
                });
                const data = await res.json();
                chatMessages.innerHTML += `<div class="mb-2"><b>Agent:</b> ${data.answer}</div>`;
            } catch (err) {
                chatMessages.innerHTML += `<div class="mb-2 text-red-600"><b>Agent:</b> Error connecting to backend.</div>`;
            }
            chatMessages.scrollTop = chatMessages.scrollHeight;
        };

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboard();
            setupEventHandlers();
            showOverviewContent(); // Initialize with overview
        });

        // Tooltip content mapping
        const tooltipContent = {
            'period-tooltip': `
                <strong>Annual View</strong><br>Shows the latest available 10-K (annual report) for each metric.<div style='margin-top: 10px'></div><strong>Latest View</strong><br>Shows the most recent 10-Q (quarterly report) for each metric.<br>If a 10-K is not available for the current year, the most recent prior 10-K is shown.
            `,
            'profit-margin-tooltip': 'Net Profit Margin = Net Income / Revenue',
            'roa-tooltip': 'Return on Assets = Net Income / Total Assets',
            'cash-ratio-tooltip': 'Cash Ratio = Cash & Equivalents / Total Assets'
        };

        // Simple tooltip functionality
        function setupTooltips() {
            console.log('Setting up tooltips...');
            
            // Add click handlers to all tooltip triggers
            document.querySelectorAll('.tooltip-trigger').forEach(trigger => {
                trigger.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const tooltipId = this.getAttribute('data-tooltip-id');
                    const tooltip = document.getElementById(tooltipId);
                    
                    if (!tooltip) {
                        console.error('Tooltip not found:', tooltipId);
                        return;
                    }
                    
                    // Hide all tooltips
                    document.querySelectorAll('[id$="-tooltip"]').forEach(t => {
                        t.style.display = 'none';
                    });
                    
                    // Show this tooltip
                    tooltip.style.display = 'block';
                };
            });
            
            // Hide tooltips when clicking outside
            document.onclick = function(e) {
                if (!e.target.closest('.tooltip-trigger')) {
                    document.querySelectorAll('[id$="-tooltip"]').forEach(tooltip => {
                        tooltip.style.display = 'none';
                    });
                }
            };
        }

        // Call setupTooltips when the DOM is loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupTooltips);
        } else {
            setupTooltips();
        }
        
        // Also call it after any dynamic content updates
        const originalUpdateDashboard = window.updateDashboard;
        window.updateDashboard = function() {
            if (originalUpdateDashboard) {
                originalUpdateDashboard();
            }
            setupTooltips();
        };

        function renderInfoIconWithTooltip(tooltipText) {
            return `
              <span class="relative group align-middle ml-1">
                <i data-lucide="info" class="h-4 w-4 text-blue-400 cursor-pointer"></i>
                <div class="custom-tooltip absolute left-1/2 transform -translate-x-1/2 mt-6 bg-black text-white rounded opacity-0 group-hover:opacity-100 transition-opacity z-10" style="min-width: 260px; max-width: 360px; font-size: 1rem; font-weight: 400; padding: 16px 20px;">
                  <div class="custom-tooltip-arrow" style="position: absolute; top: -8px; left: 50%; transform: translateX(-50%);"><svg width='16' height='8'><polygon points='0,8 8,0 16,8' style='fill:#222;'/></svg></div>
                  <div>${tooltipText}</div>
                </div>
              </span>
            `;
        }
    </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', 'Helvetica Neue', Arial, sans-serif !important;
            background: #f9fafb !important;
            color: #111827 !important;
        }
        .card {
            background: #fff !important;
            border-radius: 1rem !important;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06) !important;
            padding: 1.5rem !important;
        }
        .primary-btn {
            background: #2563eb !important;
            color: #fff !important;
            font-weight: 500 !important;
            border: none !important;
        }
        .secondary-btn {
            background: #f3f4f6 !important;
            color: #2563eb !important;
            font-weight: 500 !important;
            border: 1.5px solid #2563eb !important;
        }
        .primary-btn:active {
            background: #1d4ed8 !important;
        }
        .secondary-btn:active {
            background: #e0e7ef !important;
        }
        .custom-tooltip {
            font-family: inherit !important;
            background: #222 !important;
            color: #fff !important;
            font-size: 0.95rem !important;
            border-radius: 0.75rem !important;
            box-shadow: 0 4px 16px rgba(0,0,0,0.18) !important;
        }
        .chart-container {
            background: #fff !important;
            border-radius: 1rem !important;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06) !important;
            padding: 1rem !important;
        }
        select, button, input {
            border-radius: 0.75rem !important;
            border: 1px solid #e5e7eb !important;
            background: #f9fafb !important;
            font-family: inherit !important;
            font-size: 1rem !important;
            transition: box-shadow 0.2s !important;
        }
        select:focus, input:focus {
            outline: none !important;
            box-shadow: 0 0 0 2px #2563eb33 !important;
            border-color: #2563eb !important;
        }
        .summary-title {
            color: #6b7280 !important;
            font-size: 0.95rem !important;
            font-weight: 500 !important;
        }
        .summary-value {
            color: #111827 !important;
            font-size: 2rem !important;
            font-weight: 700 !important;
        }
        .summary-icon {
            font-size: 1.5rem !important;
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .custom-tooltip {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            top: 120%;
            background: #222;
            color: #fff;
            font-size: 0.875rem;
            font-weight: 400;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 16px rgba(0,0,0,0.18);
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            width: min(calc(100vw - 2rem), 360px);
            text-align: left;
            line-height: 1.5;
        }
        .group:hover .custom-tooltip {
            opacity: 1;
            pointer-events: auto;
        }
        .custom-tooltip-arrow {
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 16px;
            height: 8px;
            overflow: hidden;
            z-index: 10000;
        }
        .custom-tooltip-arrow svg {
            display: block;
        }
        .custom-tooltip strong { 
            font-weight: 600; 
            font-size: 0.875rem; 
        }
        .custom-tooltip .text-sm { 
            font-size: 0.75rem; 
        }
        .custom-tooltip .font-medium { 
            font-weight: 500; 
        }

        /* Responsive chart container */
        .chart-container {
            position: relative;
            width: 100%;
            height: 100%;
            min-height: 200px;
        }

        /* Responsive table styles */
        .responsive-table {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Responsive grid adjustments */
        @media (max-width: 640px) {
            .grid-cols-1 {
                grid-template-columns: repeat(1, minmax(0, 1fr));
            }
        }

        @media (min-width: 641px) and (max-width: 1024px) {
            .grid-cols-2 {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        @media (min-width: 1025px) {
            .grid-cols-4 {
                grid-template-columns: repeat(4, minmax(0, 1fr));
            }
        }
    </style>
</body>
</html>